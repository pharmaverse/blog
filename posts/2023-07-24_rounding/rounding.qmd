---
title: "Rounding"
author:
  - name: Kangjie Zhang
description: "base R `round()` and round half up in R"
date: "2023-07-24"
# please do not use any non-default categories.
# You can find the default categories in the repository README.md
categories: [rounding]
# feel free to change the image
image: "rounding.png"
---

<!--------------- typical setup ----------------->

```{r setup, include=FALSE}
long_slug <- "2023-07-24_rounding"
# renv::use(lockfile = "renv.lock")
```

<!--------------- post begins here ----------------->

## Rounding methods

Both SAS and base R have the function `round()`, which rounds the input to the specified number of decimal places.
However, they use different approaches when rounding off a 5:

-   SAS `round()` rounds half up (the common method of rounding)

-   base R `round()` [rounds to the nearest even](https://en.m.wikipedia.org/wiki/IEEE_754#Roundings_to_nearest)

Although base R does not have the option for "round half up", there are functions available in other R packages (e.g., `janitor`, `tidytlg`).
The following table lists some often-used rounding methods and their corresponding functions in SAS and R.

+---------------+----------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+
|               | round half up                          | round to even                              | round up                                   | round down                                 | round towards zero                         |
+:=============:+:======================================:+:==========================================:+:==========================================:+:==========================================:+:==========================================:+
| SAS           | `round()`                              | `rounde()`                                 | `ceil()`                                   | `floor()`                                  | `int()`                                    |
+---------------+----------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+
| R             | ::: {style="background-color: yellow"} | ::: {style="background-color: lightgreen"} | ::: {style="background-color: lightgreen"} | ::: {style="background-color: lightgreen"} | ::: {style="background-color: lightgreen"} |
|               | `janitor::round_half_up()`             | `round()`                                  | `ceiling()`                                | `floor()`                                  | `trunc()`                                  |
|               |                                        |                                            |                                            |                                            |                                            |
|               | <div>                                  | {base}                                     | {base}                                     | {base}                                     | {base}                                     |
|               |                                        | :::                                        | :::                                        | :::                                        | :::                                        |
|               | `tidytlg::roundSAS()`                  |                                            |                                            |                                            |                                            |
|               |                                        |                                            |                                            |                                            |                                            |
|               | </div>                                 |                                            |                                            |                                            |                                            |
|               | :::                                    |                                            |                                            |                                            |                                            |
+---------------+----------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+
| Example: 1.45 | 1.5                                    | 1.4                                        | 2                                          | 1                                          | 1                                          |
|               |                                        |                                            |                                            |                                            |                                            |
|               | (round to 1 decimal place)             | (round to 1 decimal place)                 |                                            |                                            |                                            |
+---------------+----------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+--------------------------------------------+

This table is summarized from links below, where more detailed discussions can be found -

-   Two SAS blogs about [round-to-even](https://blogs.sas.com/content/iml/2019/11/11/round-to-even.html) and [rounding-up-rounding-down](https://blogs.sas.com/content/iml/2011/10/03/rounding-up-rounding-down.html)

-   R documentation: Base R [Round](https://www.rdocumentation.org/packages/base/versions/3.6.2/topics/Round), [`janitor::round_half_up()`](https://sfirke.github.io/janitor/reference/round_half_up.html), [`tidytlg::roundSAS()`](https://pharmaverse.github.io/tidytlg/main/reference/roundSAS.html)

-   [CAMIS](https://psiaims.github.io/CAMIS/) (Comparing Analysis Method Implementations in Software)

## Round half up in R

The motivation for having a 'round half up' function is clear: it's a widely used rounding method, but there are no such options available in base R.

There are multiple forums that discussed this topic, and a few functions available in some R packages.
Hope you won't need to spend much time identifying a safe option for rounding half up in R after reading the following section.

### Bug fix

The first time I needed to round half up in R, I chose the function from a [PHUSE paper](https://www.lexjansen.com/phuse-us/2020/ct/CT05.pdf) and applied it to my study.
It works fine most of the time, but has issues like the following example -

```{r, message = FALSE}
# a function that rounds half up
# exact copy from: https://www.lexjansen.com/phuse-us/2020/ct/CT05.pdf
ut_round <- function(x, n=0)
{
 # x is the value to be rounded
 # n is the precision of the rounding
 scale <- 10^n
 y <- trunc(x * scale + sign(x) * 0.5) / scale
 # Return the rounded number
 return(y)
}
# round half up for 2436.845, with 2 decimal places
ut_round(2436.845, 2)
```

The expected result is 2436.85, but the output rounds it down.
The function's logic seems fine, I was not able to find the root cause.
Thanks to the community effort, there are already discussions and resolution available in a [StackOverflow post](https://stackoverflow.com/questions/12688717/round-up-from-5#comment110611119_12688836) -

> There are numerical precision issues, e.g., `round2(2436.845, 2)` returns `2436.84.` Changing `z + 0.5 to z + 0.5 + sqrt(.Machine$double.eps)` seems to work for me. -- Gregor Thomas Jun 24, 2020 at 2:16

After fixing this bug:

```{r, message = FALSE}
# revised rounds half up
ut_round1 <- function(x, n=0)
{
 # x is the value to be rounded
 # n is the precision of the rounding
 scale <- 10^n
 y <- trunc(x * scale + sign(x) * 0.5 + sqrt(.Machine$double.eps)) / scale
 # Return the rounded number
 return(y)
}
# round half up for 2436.845, with 2 decimal places
ut_round1(2436.845, 2)
```

### We are not alone

The same issue occurred in the following ones as well, and has been raised by users:

-   `janitor::round_half_up()`: [issue](https://github.com/sfirke/janitor/issues/396) was raised and fixed in v2.1.0

-   `Tplyr`: `options(tplyr.IBMRounding = TRUE)`, [issue](https://github.com/atorus-research/Tplyr/issues/124) was raised

-   `scrutiny::round_up_from()/round_up()`: [issue](https://lhdjung.github.io/scrutiny/reference/index.html#rounding) was raised

-   ...

### Which one to use?

The following two functions have the above bug fixed, they both came from the same [StackOverflow post](https://stackoverflow.com/questions/12688717/round-up-from-5).

-   [`janitor::round_half_up()`](https://sfirke.github.io/janitor/reference/round_half_up.html) **version \>= 2.1.0**
-   [`tidytlg::roundSAS()`](https://pharmaverse.github.io/tidytlg/main/reference/roundSAS.html)
    -   this function has two more arguments that can convert the result to character and allow a character string to indicate missing values

<!--------------- appendices go here ----------------->

```{r, echo=FALSE}
source("appendix.R")
insert_appendix(
  repo_spec = "pharmaverse/blog",
  name = long_slug
)
```
